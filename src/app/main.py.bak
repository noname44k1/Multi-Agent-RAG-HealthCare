"""
File ch√≠nh ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng Chatbot AI v·ªõi Agentic RAG
Ch·ª©c nƒÉng: 
- T·∫°o giao di·ªán web v·ªõi Streamlit
- X·ª≠ l√Ω t∆∞∆°ng t√°c chat v·ªõi ng∆∞·ªùi d√πng
- K·∫øt n·ªëi v·ªõi AI model ƒë·ªÉ tr·∫£ l·ªùi
- T√≠ch h·ª£p Agentic RAG v·ªõi nhi·ªÅu agent chuy√™n bi·ªát
"""

# === IMPORT C√ÅC TH∆Ø VI·ªÜN C·∫¶N THI·∫æT ===
import streamlit as st  # Th∆∞ vi·ªán t·∫°o giao di·ªán web
from dotenv import load_dotenv  # ƒê·ªçc file .env ch·ª©a API key
import sys
import os
import logging

# Th√™m th∆∞ m·ª•c cha (src) v√†o ƒë∆∞·ªùng d·∫´n ƒë·ªÉ c√≥ th·ªÉ import c√°c module t·ª´ th∆∞ m·ª•c g·ªëc
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Sau khi ƒë√£ th√™m ƒë∆∞·ªùng d·∫´n, ch√∫ng ta c√≥ th·ªÉ import c√°c module t·ª´ th∆∞ m·ª•c g·ªëc
from seed_data import seed_milvus, seed_milvus_live  # H√†m x·ª≠ l√Ω d·ªØ li·ªáu
from agents.agent_manager import AgentManager  # Qu·∫£n l√Ω agents
from langchain_community.callbacks.streamlit import StreamlitCallbackHandler
from langchain_community.chat_message_histories import StreamlitChatMessageHistory
from data_processing.pipeline import DataPipeline
from streamlit_chat import message  # Gi·∫£ ƒë·ªãnh r·∫±ng b·∫°n d√πng streamlit_chat ƒë·ªÉ hi·ªÉn th·ªã tin nh·∫Øn (ho·∫∑c s·ª≠ d·ª•ng st.chat_message c·ªßa Streamlit)

# === THI·∫æT L·∫¨P LOGGING ===
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[
        logging.StreamHandler()
    ]
)
logger = logging.getLogger("agentic_rag_chatbot")

# === THI·∫æT L·∫¨P GIAO DI·ªÜN TRANG WEB ===
def setup_page():
    """
    C·∫•u h√¨nh trang web c∆° b·∫£n
    """
    st.set_page_config(
        page_title="Tr·ª£ l√Ω AI SOICT | Agentic RAG",  # Ti√™u ƒë·ªÅ tab tr√¨nh duy·ªát
        page_icon="ü§ñ",  # Icon tab
        layout="wide"  # Giao di·ªán r·ªông
    )

# === KH·ªûI T·∫†O ·ª®NG D·ª§NG ===
def initialize_app():
    """
    Kh·ªüi t·∫°o c√°c c√†i ƒë·∫∑t c·∫ßn thi·∫øt:
    - ƒê·ªçc file .env ch·ª©a API key
    - C·∫•u h√¨nh trang web
    - Kh·ªüi t·∫°o Agent Manager
    """
    load_dotenv()  # ƒê·ªçc API key t·ª´ file .env
    setup_page()  # Thi·∫øt l·∫≠p giao di·ªán
    
    # Kh·ªüi t·∫°o Agent Manager n·∫øu ch∆∞a c√≥
    if "agent_manager" not in st.session_state:
        st.session_state.agent_manager = None

# === THANH C√îNG C·ª§ B√äN TR√ÅI ===
def setup_sidebar():
    """
    T·∫°o thanh c√¥ng c·ª• b√™n tr√°i v·ªõi c√°c t√πy ch·ªçn
    """
    with st.sidebar:
        st.title("‚öôÔ∏è C·∫•u h√¨nh")
        
        # Ph·∫ßn 1: Ch·ªçn Model ƒë·ªÉ tr·∫£ l·ªùi
        st.header("ü§ñ Model AI")
        model_choice = st.radio(
            "Ch·ªçn AI Model ƒë·ªÉ tr·∫£ l·ªùi:",
            ["OpenAI GPT-4", "OpenAI GPT-4o-mini-2024-07-18", "OpenAI o3-mini"]
        )
        
        # Ph·∫ßn 2: C·∫•u h√¨nh Data
        st.header("üìö Ngu·ªìn d·ªØ li·ªáu")
        data_source = st.radio(
            "Ch·ªçn ngu·ªìn d·ªØ li·ªáu:",
            ["File Local", "URL tr·ª±c ti·∫øp"]
        )
        
        # X·ª≠ l√Ω ngu·ªìn d·ªØ li·ªáu
        if data_source == "File Local":
            handle_local_file()
        else:
            handle_url_input()
            
        # Ph·∫ßn 3: Ch·ªçn lƒ©nh v·ª±c v√† collection t∆∞∆°ng ·ª©ng
        st.header("üîç Lƒ©nh v·ª±c truy v·∫•n")
        domain_choice = st.radio(
            "Ch·ªçn lƒ©nh v·ª±c mu·ªën truy v·∫•n:",
            ["Stack AI", "Thu·∫ø", "Y T·∫ø", "T√πy ch·ªânh"]
        )
        
        # Kh·ªüi t·∫°o Agent Manager v·ªõi model ƒë√£ ch·ªçn
        if st.session_state.agent_manager is None or st.session_state.agent_manager.model_choice != model_choice:
            logger.info(f"Kh·ªüi t·∫°o Agent Manager v·ªõi model: {model_choice}")
            st.session_state.agent_manager = AgentManager(model_choice)
        
        # L·∫•y collection t∆∞∆°ng ·ª©ng v·ªõi lƒ©nh v·ª±c
        collections_to_query = st.session_state.agent_manager.get_collections_for_domain(domain_choice)
        
        # N·∫øu ch·ªçn t√πy ch·ªânh, cho ph√©p ng∆∞·ªùi d√πng ch·ªçn collection
        if domain_choice == "T√πy ch·ªânh":
        # Danh s√°ch collection m·∫∑c ƒë·ªãnh
            default_collections = ["stack_ai_docs", "QA_Thue_test", "medical_QA"]
        selected_collections = st.multiselect(
            "Ch·ªçn c√°c collection t·ª´ danh s√°ch:",
            options=default_collections,
                default=[],
            help="Ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu collection ƒë·ªÉ truy v·∫•n th√¥ng tin"
        )
        
        # √î nh·∫≠p t√πy √Ω ƒë·ªÉ th√™m collection kh√°c
        custom_collection = st.text_input(
            "Th√™m collection t√πy √Ω (·∫•n Enter ƒë·ªÉ th√™m):",
            "",
            help="Nh·∫≠p t√™n collection kh√°c n·∫øu kh√¥ng c√≥ trong danh s√°ch"
        )
        
        # K·∫øt h·ª£p danh s√°ch collection ƒë√£ ch·ªçn v√† t√πy √Ω
        collections_to_query = selected_collections
        if custom_collection and custom_collection not in collections_to_query:
            collections_to_query.append(custom_collection)
        
        # Hi·ªÉn th·ªã danh s√°ch collection ƒë√£ ch·ªçn
        if collections_to_query:
            st.write("Collections s·∫Ω ƒë∆∞·ª£c truy v·∫•n:", ", ".join(collections_to_query))
        else:
            st.warning("Ch∆∞a ch·ªçn collection n√†o!")
        
        # C·∫≠p nh·∫≠t session state v·ªõi l·ª±a ch·ªçn lƒ©nh v·ª±c
        if "domain" not in st.session_state or st.session_state.domain != domain_choice:
            st.session_state.domain = domain_choice
            # Kh·ªüi t·∫°o agent cho lƒ©nh v·ª±c ƒë∆∞·ª£c ch·ªçn
            try:
                logger.info(f"Chuy·ªÉn ƒë·ªïi sang lƒ©nh v·ª±c: {domain_choice}")
                st.session_state.agent_manager.switch_domain(domain_choice, collections_to_query)
                # Reset cu·ªôc tr√≤ chuy·ªán khi chuy·ªÉn lƒ©nh v·ª±c
                if "current_conversation" in st.session_state:
                    intro_message = get_intro_message(domain_choice)
                    st.session_state.current_conversation = [{"role": "assistant", "content": intro_message}]
            except ValueError as e:
                st.error(str(e))
        
        return domain_choice, collections_to_query

def get_intro_message(domain):
    """
    Tr·∫£ v·ªÅ th√¥ng ƒëi·ªáp ch√†o m·ª´ng t∆∞∆°ng ·ª©ng v·ªõi lƒ©nh v·ª±c
    """
    intro_messages = {
        "Stack AI": "Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI v·ªÅ Stack AI. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i v·ªÅ c√°c t√≠nh nƒÉng, c√°ch s·ª≠ d·ª•ng ho·∫∑c th√¥ng tin v·ªÅ n·ªÅn t·∫£ng Stack AI.",
        "Thu·∫ø": "Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI v·ªÅ thu·∫ø. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i v·ªÅ c√°c quy ƒë·ªãnh thu·∫ø, k√™ khai thu·∫ø, ho·∫∑c c√°c v·∫•n ƒë·ªÅ li√™n quan ƒë·∫øn thu·∫ø.",
        "Y T·∫ø": "Xin ch√†o! T√¥i l√† tr·ª£ l√Ω AI y t·∫ø. B·∫°n c√≥ th·ªÉ h·ªèi t√¥i v·ªÅ c√°c th√¥ng tin y t·∫ø, tri·ªáu ch·ª©ng b·ªánh, ho·∫∑c ki·∫øn th·ª©c y khoa ph·ªï bi·∫øn.",
        "T√πy ch·ªânh": "T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n? B·∫°n c√≥ th·ªÉ h·ªèi t√¥i v·ªÅ b·∫•t k·ª≥ ch·ªß ƒë·ªÅ n√†o trong c√°c collection b·∫°n ƒë√£ ch·ªçn."
    }
    return intro_messages.get(domain, "T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?")

def handle_local_file():
    """
    X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn t·∫£i file
    """
    collection_name = st.text_input(
        "T√™n collection trong Milvus:", 
        "data_test",
        help="Nh·∫≠p t√™n collection b·∫°n mu·ªën l∆∞u trong Milvus"
    )
    filename = st.text_input("T√™n file JSON:", "stack.json")
    directory = st.text_input("Th∆∞ m·ª•c ch·ª©a file:", "data")
    
    if st.button("T·∫£i d·ªØ li·ªáu t·ª´ file"):
        if not collection_name:
            st.error("Vui l√≤ng nh·∫≠p t√™n collection!")
            return
            
        with st.spinner("ƒêang t·∫£i d·ªØ li·ªáu..."):
            try:
                seed_milvus(
                    'http://localhost:19530', 
                    collection_name, 
                    filename, 
                    directory
                )
                st.success(f"ƒê√£ t·∫£i d·ªØ li·ªáu th√†nh c√¥ng v√†o collection '{collection_name}'!")
            except Exception as e:
                st.error(f"L·ªói khi t·∫£i d·ªØ li·ªáu: {str(e)}")

def handle_url_input():
    """
    X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn crawl URL
    """
    collection_name = st.text_input(
        "T√™n collection trong Milvus:", 
        "data_test_live",
        help="Nh·∫≠p t√™n collection b·∫°n mu·ªën l∆∞u trong Milvus"
    )
    url = st.text_input("Nh·∫≠p URL:", "https://www.stack-ai.com/docs")
    
    if st.button("Crawl d·ªØ li·ªáu"):
        if not collection_name:
            st.error("Vui l√≤ng nh·∫≠p t√™n collection!")
            return
            
        with st.spinner("ƒêang crawl d·ªØ li·ªáu..."):
            try:
                seed_milvus_live(
                    url, 
                    'http://localhost:19530', 
                    collection_name, 
                    'stack-ai'
                )
                st.success(f"ƒê√£ crawl d·ªØ li·ªáu th√†nh c√¥ng v√†o collection '{collection_name}'!")
            except Exception as e:
                st.error(f"L·ªói khi crawl d·ªØ li·ªáu: {str(e)}")

# === GIAO DI·ªÜN CHAT CH√çNH ===
def setup_conversation_history(domain_choice):
    # N·∫øu ch∆∞a c√≥, kh·ªüi t·∫°o bi·∫øn l∆∞u tr·ªØ l·ªãch s·ª≠ c√°c cu·ªôc tr√≤ chuy·ªán (l√† dictionary)
    if "conversations" not in st.session_state:
        st.session_state.conversations = {}
    # Kh·ªüi t·∫°o cu·ªôc tr√≤ chuy·ªán hi·ªán t·∫°i n·∫øu ch∆∞a c√≥
    if "current_conversation" not in st.session_state:
        intro_message = get_intro_message(domain_choice)
        st.session_state.current_conversation = [{"role": "assistant", "content": intro_message}]
    # Trong sidebar, hi·ªÉn th·ªã l·ªãch s·ª≠ c√°c cu·ªôc tr√≤ chuy·ªán v√† cho ph√©p chuy·ªÉn ƒë·ªïi
    st.sidebar.header("üóÇ L·ªãch s·ª≠ cu·ªôc tr√≤ chuy·ªán")
    # T·∫°o danh s√°ch c√°c t√πy ch·ªçn: "Cu·ªôc tr√≤ chuy·ªán hi·ªán t·∫°i" v√† t√™n c√°c cu·ªôc tr√≤ chuy·ªán ƒë√£ l∆∞u
    conv_options = ["Cu·ªôc tr√≤ chuy·ªán hi·ªán t·∫°i"] + list(st.session_state.conversations.keys())
    selected_conv = st.sidebar.selectbox("Ch·ªçn cu·ªôc tr√≤ chuy·ªán:", conv_options)
    if selected_conv != "Cu·ªôc tr√≤ chuy·ªán hi·ªán t·∫°i":
        # N·∫øu ng∆∞·ªùi d√πng ch·ªçn cu·ªôc tr√≤ chuy·ªán ƒë√£ l∆∞u, load l·∫°i tin nh·∫Øn v√†o current_conversation
        st.session_state.current_conversation = st.session_state.conversations[selected_conv].copy()
    # N√∫t t·∫°o cu·ªôc tr√≤ chuy·ªán m·ªõi
    if st.sidebar.button("T·∫°o cu·ªôc tr√≤ chuy·ªán m·ªõi"):
        # N·∫øu current_conversation c√≥ nhi·ªÅu tin nh·∫Øn (kh√¥ng ph·∫£i m·ªõi ch·ªâ ch·ª©a tin ch√†o), l∆∞u l·∫°i v√†o l·ªãch s·ª≠
        if len(st.session_state.current_conversation) > 1:
            new_conv_name = st.sidebar.text_input("Nh·∫≠p t√™n cu·ªôc tr√≤ chuy·ªán m·ªõi:", key="new_conv_name")
            if new_conv_name:
                st.session_state.conversations[new_conv_name] = st.session_state.current_conversation.copy()
                st.sidebar.success(f"ƒê√£ l∆∞u cu·ªôc tr√≤ chuy·ªán '{new_conv_name}'.")
        # Reset cu·ªôc tr√≤ chuy·ªán hi·ªán t·∫°i v·ªõi th√¥ng ƒëi·ªáp ch√†o m·ª´ng t∆∞∆°ng ·ª©ng v·ªõi lƒ©nh v·ª±c
        intro_message = get_intro_message(domain_choice)
        st.session_state.current_conversation = [{"role": "assistant", "content": intro_message}]
    return st.session_state.current_conversation

def setup_chat_interface(domain_choice):
    st.title(f"ü§ñ Agentic RAG Chatbot - {domain_choice}")

    # Hi·ªÉn th·ªã th√¥ng tin v·ªÅ lƒ©nh v·ª±c hi·ªán t·∫°i
    domain_descriptions = {
        "Stack AI": "H·ªèi ƒë√°p v·ªÅ n·ªÅn t·∫£ng Stack AI v√† c√°ch s·ª≠ d·ª•ng n√≥.",
        "Thu·∫ø": "H·ªèi ƒë√°p v·ªÅ c√°c v·∫•n ƒë·ªÅ li√™n quan ƒë·∫øn thu·∫ø, k√™ khai thu·∫ø v√† quy ƒë·ªãnh thu·∫ø.",
        "Y T·∫ø": "H·ªèi ƒë√°p v·ªÅ c√°c v·∫•n ƒë·ªÅ y t·∫ø, th√¥ng tin y khoa v√† s·ª©c kh·ªèe.",
        "T√πy ch·ªânh": "H·ªèi ƒë√°p v·ªÅ b·∫•t k·ª≥ ch·ªß ƒë·ªÅ n√†o trong c√°c collections b·∫°n ƒë√£ ch·ªçn."
    }
    
    st.info(domain_descriptions.get(domain_choice, "Tr·ª£ l√Ω AI ƒëa lƒ©nh v·ª±c."))
    
    # K·∫øt h·ª£p t√≠nh nƒÉng qu·∫£n l√Ω l·ªãch s·ª≠ cu·ªôc tr√≤ chuy·ªán
    current_convo = setup_conversation_history(domain_choice)
    
    # V√≠ d·ª• hi·ªÉn th·ªã tin nh·∫Øn qua StreamlitChatMessageHistory
    msgs = StreamlitChatMessageHistory(key="langchain_messages")
    
    # N·∫øu current_conversation ƒë∆∞·ª£c load t·ª´ l·ªãch s·ª≠ th√¨ hi·ªÉn th·ªã t·∫•t c·∫£ c√°c tin nh·∫Øn ƒë√≥
    for msg in current_convo:
        role = "assistant" if msg["role"] == "assistant" else "human"
        st.chat_message(role).write(msg["content"])
    
    return msgs, current_convo

# === X·ª¨ L√ù TIN NH·∫ÆN NG∆Ø·ªúI D√ôNG ===
def handle_user_input(msgs, current_convo):
    """
    X·ª≠ l√Ω khi ng∆∞·ªùi d√πng g·ª≠i tin nh·∫Øn:
      1. Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
      2. G·ªçi AI ƒë·ªÉ x·ª≠ l√Ω v√† tr·∫£ l·ªùi
      3. C·∫≠p nh·∫≠t c·∫£ current_conversation v√† hi·ªÉn th·ªã
    """
    if prompt := st.chat_input("H√£y h·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨!"):
        # C·∫≠p nh·∫≠t current conversation v√† hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
        current_convo.append({"role": "human", "content": prompt})
        st.chat_message("human").write(prompt)
        msgs.add_user_message(prompt)

        # X·ª≠ l√Ω v√† hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi c·ªßa AI v·ªõi callback v√† l·ªãch s·ª≠ chat
        with st.chat_message("assistant"):
            # Thi·∫øt l·∫≠p callback ƒë·ªÉ theo d√µi s·ª± ki·ªán trong qu√° tr√¨nh t∆∞∆°ng t√°c
            st_callback = StreamlitCallbackHandler(st.container())
            
            # L·∫•y l·ªãch s·ª≠ chat (tr·ª´ tin nh·∫Øn ng∆∞·ªùi d√πng m·ªõi nh·∫•t)
            chat_history = [
                {"role": msg["role"], "content": msg["content"]}
                for msg in current_convo[:-1]
            ]

            try:
                # G·ªçi Agent Manager ƒë·ªÉ x·ª≠ l√Ω c√¢u h·ªèi
                response = st.session_state.agent_manager.query(
                    prompt,
                    chat_history
                )

                # L∆∞u v√† hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi t·ª´ AI
                output = response["output"]
                current_convo.append({"role": "assistant", "content": output})  # C·∫≠p nh·∫≠t l·ªãch s·ª≠
                msgs.add_ai_message(output)  # G·ª≠i tin nh·∫Øn AI v√†o giao di·ªán
                st.write(output)  # Hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi tr√™n giao di·ªán
                
            except Exception as e:
                error_message = f"ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω c√¢u h·ªèi: {str(e)}"
                logger.error(error_message)
                current_convo.append({"role": "assistant", "content": error_message})
                msgs.add_ai_message(error_message)
                st.write(error_message)

# === H√ÄM CH√çNH ===
def main():
    """
    H√†m ch√≠nh ƒëi·ªÅu khi·ªÉn lu·ªìng ch∆∞∆°ng tr√¨nh
    """
    initialize_app()
    domain_choice, collections_to_query = setup_sidebar()
    msgs, current_convo = setup_chat_interface(domain_choice)
    
    # X·ª≠ l√Ω input t·ª´ ng∆∞·ªùi d√πng
    handle_user_input(msgs, current_convo)

def process_new_documents():
    """
    X·ª≠ l√Ω t√†i li·ªáu m·ªõi v√† chu·∫©n b·ªã ƒë·ªÉ ƒë∆∞a v√†o vector database
    """
    # Kh·ªüi t·∫°o pipeline
    pipeline = DataPipeline()
    
    # X·ª≠ l√Ω documents
    results_df = pipeline.process_documents(
        directory="/Users/daomanh/Desktop/Build-An-LLM-RAG-Chatbot-With-LangChain-Python/src/qa_data"
    )
    
    # Chu·∫©n b·ªã data cho Milvus
    milvus_records = pipeline.prepare_for_milvus(results_df)
    
    # L∆∞u v√†o Milvus (s·ª≠ d·ª•ng code hi·ªán t·∫°i c·ªßa b·∫°n)
    # store_in_milvus(milvus_records)

# Ch·∫°y ·ª©ng d·ª•ng
if __name__ == "__main__":
    main() 